<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>前端必须知道的Event Loop | 猪脚面线的知识库</title>
    <meta name="description" content="For what it&#39;s worth, it&#39;s never too late.（Updating... XD）">
    <link rel="icon" href="/isaacgaoblog/logo.ico">
    
    <link rel="preload" href="/isaacgaoblog/assets/css/0.styles.60655061.css" as="style"><link rel="preload" href="/isaacgaoblog/assets/js/app.01da7489.js" as="script"><link rel="preload" href="/isaacgaoblog/assets/js/15.90b7ef7b.js" as="script"><link rel="prefetch" href="/isaacgaoblog/assets/js/10.bb6e04e4.js"><link rel="prefetch" href="/isaacgaoblog/assets/js/11.391fd545.js"><link rel="prefetch" href="/isaacgaoblog/assets/js/12.602facc5.js"><link rel="prefetch" href="/isaacgaoblog/assets/js/13.2d9982a6.js"><link rel="prefetch" href="/isaacgaoblog/assets/js/14.83aaa352.js"><link rel="prefetch" href="/isaacgaoblog/assets/js/16.fb97507d.js"><link rel="prefetch" href="/isaacgaoblog/assets/js/17.d2fb61a5.js"><link rel="prefetch" href="/isaacgaoblog/assets/js/18.5f85ae3a.js"><link rel="prefetch" href="/isaacgaoblog/assets/js/19.b706601e.js"><link rel="prefetch" href="/isaacgaoblog/assets/js/2.3704caf5.js"><link rel="prefetch" href="/isaacgaoblog/assets/js/20.66d4ff5f.js"><link rel="prefetch" href="/isaacgaoblog/assets/js/21.341d678b.js"><link rel="prefetch" href="/isaacgaoblog/assets/js/22.3af63f24.js"><link rel="prefetch" href="/isaacgaoblog/assets/js/23.4ecf9c22.js"><link rel="prefetch" href="/isaacgaoblog/assets/js/24.15a6c94a.js"><link rel="prefetch" href="/isaacgaoblog/assets/js/25.bc5a5667.js"><link rel="prefetch" href="/isaacgaoblog/assets/js/26.823bab78.js"><link rel="prefetch" href="/isaacgaoblog/assets/js/27.0327437d.js"><link rel="prefetch" href="/isaacgaoblog/assets/js/28.db82409c.js"><link rel="prefetch" href="/isaacgaoblog/assets/js/29.e695a449.js"><link rel="prefetch" href="/isaacgaoblog/assets/js/3.98b19d1d.js"><link rel="prefetch" href="/isaacgaoblog/assets/js/4.4d6e9538.js"><link rel="prefetch" href="/isaacgaoblog/assets/js/5.44d0334a.js"><link rel="prefetch" href="/isaacgaoblog/assets/js/6.b35e585c.js"><link rel="prefetch" href="/isaacgaoblog/assets/js/7.723d1e3a.js"><link rel="prefetch" href="/isaacgaoblog/assets/js/8.e2bfc8ff.js"><link rel="prefetch" href="/isaacgaoblog/assets/js/9.508f61f1.js">
    <link rel="stylesheet" href="/isaacgaoblog/assets/css/0.styles.60655061.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/isaacgaoblog/" class="home-link router-link-active"><!----> <span class="site-name">猪脚面线的知识库</span></a> <div class="links" style="max-width:nullpx;"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/isaacgaoblog/" class="nav-link">主页</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">知识库</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/isaacgaoblog/article/frontend/" class="nav-link">前端</a></li><li class="dropdown-item"><!----> <a href="/isaacgaoblog/article/backend/" class="nav-link">后端</a></li></ul></div></div><div class="nav-item"><a href="/isaacgaoblog/posts/" class="nav-link router-link-active">博文</a></div><div class="nav-item"><a href="https://www.github.com/Cobatkao" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Github
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <div class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/isaacgaoblog/" class="nav-link">主页</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">知识库</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/isaacgaoblog/article/frontend/" class="nav-link">前端</a></li><li class="dropdown-item"><!----> <a href="/isaacgaoblog/article/backend/" class="nav-link">后端</a></li></ul></div></div><div class="nav-item"><a href="/isaacgaoblog/posts/" class="nav-link router-link-active">博文</a></div><div class="nav-item"><a href="https://www.github.com/Cobatkao" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Github
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav>  <ul class="sidebar-links"><li><div class="sidebar-group first"><p class="sidebar-heading open"><span>博文</span> <!----></p> <ul class="sidebar-group-items"><li><a href="/isaacgaoblog/posts/" class="sidebar-link">碎碎念</a></li><li><a href="/isaacgaoblog/posts/布局全解.html" class="sidebar-link">布局全解</a></li><li><a href="/isaacgaoblog/posts/重绘与重排.html" class="sidebar-link">重绘与重排</a></li><li><a href="/isaacgaoblog/posts/小白也可以搞懂的闭包.html" class="sidebar-link">小白也可以搞懂的闭包</a></li><li><a href="/isaacgaoblog/posts/小白上手Promise.html" class="sidebar-link">小白上手Promise</a></li><li><a href="/isaacgaoblog/posts/多人博客项目review.html" class="sidebar-link">多人博客项目Review</a></li><li><a href="/isaacgaoblog/posts/前端必须知道的HTTP缓存.html" class="sidebar-link">前端必须知道的HTTP缓存</a></li><li><a href="/isaacgaoblog/posts/从封装两个函数到入门jQuery.html" class="sidebar-link">从封装两个函数到入门jQuery</a></li><li><a href="/isaacgaoblog/posts/webpack4初次上手.html" class="sidebar-link">初次上手webpack4</a></li><li><a href="/isaacgaoblog/posts/Vue.2.x全家桶学习手记.html" class="sidebar-link">使用语雀整理Vue笔记</a></li><li><a href="/isaacgaoblog/posts/HTTPS通信机制.html" class="sidebar-link">HTTPS通信机制</a></li><li><a href="/isaacgaoblog/posts/Event_Loop和任务队列.html" class="active sidebar-link">前端必须知道的Event Loop</a></li></ul></div></li></ul> </div> <div class="page"> <div class="content"><p>本篇博文关注事件循环，任务队列等知识点XD。</p> <h1 id="碎碎念"><a href="#碎碎念" aria-hidden="true" class="header-anchor">#</a> 碎碎念</h1> <p>听多了javascript线程，异步，v8等等概念，便会很想知道javascript到底是如何利用单线程来实现异步的？在网络上逛了一阵子，感觉大多数都说的不清楚，或者说有些文章年代久远，跟不上最新的规范（es66），所以我写这篇博文，来简短的梳理下<strong>事件循环与任务队列</strong>的思路！</p> <p>在开始正文前，有一点很重要：</p> <blockquote><p>事件循环与任务队列是<code>JS</code>实现异步无阻塞极为重要的概念。这两个概念在ES5与ES6两个规范中的实现各位不同。尤其在ES6标准中，清楚的区分<strong>宏观任务队列</strong>和<strong>微观任务队列</strong>才能解释Promise一些看似奇怪的表现。</p></blockquote> <p>好，认清这一点后我们开始XD。</p> <h1 id="事件循环"><a href="#事件循环" aria-hidden="true" class="header-anchor">#</a> 事件循环</h1> <p>事件循环是什么？为什么要有事件循环？我们都知道V8引擎遍历脚本中每一行代码，自上而下一次执行，但是像<code>AJAX</code>请求数据这样很耗时的任务，就需要异步执行。否则主线程干等着造成浏览器假死，用户体验极差。

而<code>JS</code>的设计者提出的方法就是事件循环，一个线程中，事件循环是唯一的，而任务队列可以拥有多个。</p> <h1 id="任务队列"><a href="#任务队列" aria-hidden="true" class="header-anchor">#</a> 任务队列</h1> <p>队列是什么？一种<strong>先进先出</strong>的数据结构。队头的一项总是最先处理。任务是什么？<code>Web API</code>返回的一个个回调函数，它的存在使得<code>JS</code>主线程在空闲时抽取任务队列排在队头的任务时，知道该回调所对应的异步任务完成了，下一步就要执行该回调函数。</p> <p>主线程可以拥有<strong>多个任务队列</strong>，在ES6规范中，根据来源的不同分为<code>macro-task</code>（宏任务）与<code>micro-task</code>（微任务），在最新标准中，它们被分别称为<code>task</code>与<code>jobs</code>。任务源是什么？诸如定时器，事件，Promise，ajax等都是任务源。</p> <p>后面我们再讨论<code>macro-task</code>（宏任务）与<code>micro-task</code>（微任务）。</p> <h1 id="演示"><a href="#演示" aria-hidden="true" class="header-anchor">#</a> 演示</h1> <p>下面我们来看事件循环到底是怎么进行的。</p> <p><img src="https://camo.githubusercontent.com/054bbbb893fb49821fc1331d42e07bdd17abef81/68747470733a2f2f706963322e7a68696d672e636f6d2f38302f76322d64613037386661336561646633646234626634353539303461653036663834625f68642e6a7067" alt="pic"></p> <ol><li>函数调用栈：主线程运行的时候，产生堆（heap）和栈（stack）；</li> <li>Web APIs：浏览器接口，调用栈中的代码调用各种外部API，如<code>onclick</code>由浏览器内核的<code>DOM Binding</code>模块来处理，当事件触发的时候，回调函数会排进任务队列。类似的，<code>ajax</code>则会由浏览器内核的<code>network</code>模块来处理，在网络请求完成后，将回调排进任务队列后。</li> <li>任务队列：如上，任务队列中加入各种事件（click，load，done），且按照来源归属在各自队列中。</li></ol> <p>一个具体点的栗子。比如现在打开了一个页面，里边有一段<code>&lt;script&gt;</code>，其中有Ajax，DOM操作等等。这段JS是在浏览器提供的全局环境（浏览器中是window）里执行的，执行中遇到函数调用时会压入执行栈。</p> <ol><li>主线程在遇到<code>Ajax</code>或是<code>setTimeout</code>这种异步操作时会交给浏览器的<code>WebAPIs</code>，然后继续执行后边的代码，直到最后执行栈为空。</li> <li>浏览器会在异步任务完成后，排到相应的任务队列后。</li> <li>等到主线程执行栈为空后，主线程会去异步队列抽取最先被推入的异步事件，放入执行栈中，执行其中的回调同步代码。任务队列是具有优先级的，按照优先级决定访问的先后顺序。而优先级在不同的环境中会有所不同，所以不能给出一个固定的优先级。</li> <li>每访问一个队列，执行栈会执行完这个任务队列的所有的代码，然后再取下一个任务队列需要执行的的代码。如果在执行中遇到了当前属于任务队列的异步任务时。此次任务的返回不会直接排到当前任务队列之后。因为这属于两次不同的事件循环，会被区分开来。</li></ol> <p>就这样循环执行，直到三大块全为空，这称为事件循环。</p> <h1 id="宏任务与微任务"><a href="#宏任务与微任务" aria-hidden="true" class="header-anchor">#</a> 宏任务与微任务</h1> <p>看一道题：</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span>resolve<span class="token punctuation">,</span>reject<span class="token punctuation">)</span><span class="token punctuation">{</span>
	console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>
	<span class="token function">resolve</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span>val<span class="token punctuation">)</span><span class="token punctuation">{</span>
	console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>val<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token comment">//2、3、1</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><p>第一次看到上面的代码，其实会很纠结到底会按照什么顺序执行。这就涉及到ES6规范中的任务队列类别。</p> <p>一般因为异步任务之间并不相同，因此他们的执行优先级也有区别。不同的异步任务被分为两类：微任务（micro task）和宏任务（macro task）。</p> <p>以下事件属于宏任务：</p> <ul><li><code>MessageChannel</code></li> <li><code>postMessage</code></li> <li><code>setImmediate</code></li> <li>网络请求<code>Ajax</code></li> <li><code>setTimeout</code></li></ul> <p>以下事件属于微任务：</p> <ul><li>Promise()</li> <li>nextTick队列</li></ul> <p>添加了微观任务队列之后事件循环有什么变化呢？在执行栈执行的过程中会把属于微观任务队列的任务分配到相应的微观任务队列中去。而在调用栈执行空之后，主线程读取任务队列时，会<strong>先读取所有微观任务队列</strong>，然后读取<strong>一个宏观任务队列</strong>，<strong>再读取所有的微观任务队列</strong>。如图：</p> <p><img src="https://kongchenglc.github.io/imgs/rwdl.png" alt="pic"></p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span>resolve<span class="token punctuation">)</span><span class="token punctuation">{</span>
	console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
	<span class="token keyword">for</span><span class="token punctuation">(</span> <span class="token keyword">var</span> i<span class="token operator">=</span><span class="token number">0</span> <span class="token punctuation">;</span> i<span class="token operator">&lt;</span><span class="token number">10000</span> <span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">)</span><span class="token punctuation">{</span>
		i<span class="token operator">==</span><span class="token number">9999</span> <span class="token operator">&amp;&amp;</span> <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
	console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><ul><li>脚本开始执行，最先遇到setTimeout，交给浏览器去计时，达到setTimeout限制最短计时之后，把这个任务推入setTimeout队列。</li> <li>遇到Promise构造函数，构造函数参数执行，输出1，调用resolve改变Promise对象的状态，然后输出2。</li> <li>Promise对象调用then方法，将这个任务推入Promise任务队列。</li> <li>执行console.log(3)，输出3。</li> <li>同步任务执行完可，调用栈为空读，取任务队列，按照：抽取，执行微观任务 ---&gt; 抽取，执行宏观任务 ---&gt; 抽取执行微观任务队列 .... 依次循环。
<ul><li>读取所有微观任务队列中的任务，执行这些任务指定的回调函数。执行then指定的回调函数，输出5（微观任务队列具有优先级）。</li> <li>最后读取到setTimeout的任务，执行回调函数，输出4。</li></ul></li> <li>所以最后的输出顺序是1,2,3,5,4，而不是1,2,3,4,5。如果不清楚微观任务队列的执行机制，很容易将两个异步任务归为一类，将执行顺序判断错误。</li></ul> <h1 id="小结"><a href="#小结" aria-hidden="true" class="header-anchor">#</a> 小结</h1> <p>我们只需记住当当前执行栈执行完毕时会立刻先处理所有微任务队列中的事件，然后再去宏任务队列中取出一个事件。</p> <p>同一次事件循环中，微任务永远在宏任务之前执行。
所以我们就很好解释上面的那段代码了。</p></div> <div class="page-edit"><!----> <!----></div> <!----> </div> <!----></div></div>
    <script src="/isaacgaoblog/assets/js/app.01da7489.js" defer></script><script src="/isaacgaoblog/assets/js/15.90b7ef7b.js" defer></script>
  </body>
</html>
